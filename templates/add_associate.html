{% extends "base.html" %}
{% block title %}Add Associate{% endblock %}
{% block content %}

<h1 class="title has-text-centered">Add Associate</h1>

<!-- Tab Navigation -->
<div class="tabs is-centered is-boxed">
  <ul>
    <li class="is-active" data-tab="basic"><a>ðŸ§‘ Basic Info</a></li>
    <li data-tab="job"><a>ðŸ’¼ Job Details</a></li>
    <li data-tab="performance"><a>ðŸ“Š Performance & Salary</a></li>
    <li data-tab="other"><a>ðŸ“‹ Other Details</a></li>
  </ul>
</div>

<form method="POST">
  <!-- BASIC INFO -->
  <div class="tab-content" id="basic" style="display: block;">
    <div class="field">
      <label class="label">Associate ID</label>
      <input class="input" type="number" name="associate_id"
             value="{{ form_data.get('associate_id','') }}">
    </div>

    <div class="field">
      <label class="label">Name</label>
      <input class="input" type="text" name="associate_name"
             value="{{ form_data.get('associate_name','') }}">
    </div>

    <div class="field">
      <label class="label">Gender</label>
      <div class="control is-flex">
        <div class="select is-fullwidth">
          <select name="gender" id="gender">
            {% for g in dropdowns.get("gender", []) %}
              <option value="{{ g }}" {% if form_data.get("gender") == g %}selected{% endif %}>{{ g }}</option>
            {% endfor %}
          </select>
        </div>
        <button type="button" class="button is-small is-info ml-2"
                onclick="addNewOption('gender')">+</button>
      </div>
    </div>

    <div class="field">
      <label class="label">Marital Status</label>
      <div class="control is-flex">
        <div class="select is-fullwidth">
          <select name="marital_status" id="marital_status">
            {% for ms in dropdowns.get("marital_status", []) %}
              <option value="{{ ms }}" {% if form_data.get("marital_status") == ms %}selected{% endif %}>{{ ms }}</option>
            {% endfor %}
          </select>
        </div>
        <button type="button" class="button is-small is-info ml-2"
                onclick="addNewOption('marital_status')">+</button>
      </div>
    </div>

    <button class="button is-info mt-3" type="submit" name="action" value="save_section">
      Save Section
    </button>
  </div>

  <!-- JOB DETAILS -->
  <div class="tab-content" id="job" style="display: none;">
    <div class="field">
      <label class="label">Department</label>
      <div class="control is-flex">
        <div class="select is-fullwidth">
          <select name="department" id="department" onchange="autoFillDepartmentId()">
            <option value="">Select Department</option>
            {% for dept in dropdowns.get("department", []) %}
              <option value="{{ dept }}" {% if form_data.get("department") == dept %}selected{% endif %}>
                {{ dept }}
              </option>
            {% endfor %}
          </select>
        </div>
        <button type="button" class="button is-small is-info ml-2"
                onclick="addNewOption('department')">+</button>
      </div>
    </div>

    <div class="field">
      <label class="label">Department ID</label>
      <input class="input" type="number" name="department_id" id="department_id" readonly
             value="{{ form_data.get('department_id','') }}">
    </div>

    <div class="field">
      <label class="label">Employment Status</label>
      <input class="input" type="text" name="employment_status"
             value="{{ form_data.get('employment_status','') }}">
    </div>

    <div class="field">
      <label class="label">Terminated (0/1)</label>
      <div class="select is-fullwidth">
        <select name="terminated" id="terminated" onchange="toggleTerminationReason()">
          {% for t in dropdowns.get("terminated", ["0 - No","1 - Yes"]) %}
            <option value="{{ t.split(' ')[0] }}" {% if form_data.get("terminated") == t.split(' ')[0] %}selected{% endif %}>
              {{ t }}
            </option>
          {% endfor %}
        </select>
      </div>
    </div>

    <div class="field">
      <label class="label">Termination Reason</label>
      <div class="control is-flex">
        <div class="select is-fullwidth">
          <select name="termination_reason" id="termination_reason" disabled>
            {% for tr in dropdowns.get("termination_reason", ["N/A","Performance","Resigned","Layoff"]) %}
              <option value="{{ tr }}" {% if form_data.get("termination_reason") == tr %}selected{% endif %}>
                {{ tr }}
              </option>
            {% endfor %}
          </select>
        </div>
        <button type="button" class="button is-small is-info ml-2"
                onclick="addNewOption('termination_reason')">+</button>
      </div>
    </div>

    <div class="field">
      <label class="label">Manager Name</label>
      <div class="control is-flex">
        <div class="select is-fullwidth">
          <select name="manager_name" id="manager_name" onchange="autoFillManagerId()">
            <option value="">-- Select Manager --</option>
            {% for m in managers %}
              <option value="{{ m.manager_name }}" data-id="{{ m.manager_id }}"
                {% if form_data.get('manager_name') == m.manager_name %}selected{% endif %}>
                {{ m.manager_name }}
              </option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>

    <div class="field">
      <label class="label">Manager ID</label>
      <input class="input" type="number" name="manager_id" id="manager_id" readonly
             value="{{ form_data.get('manager_id','') }}">
    </div>

    <div class="field">
      <label class="label">Recruitment Through</label>
      <div class="control is-flex">
        <div class="select is-fullwidth">
          <select name="recruitment" id="recruitment">
            {% for r in dropdowns.get("recruitment", ["Agency","Referral","Direct"]) %}
              <option value="{{ r }}" {% if form_data.get("recruitment") == r %}selected{% endif %}>{{ r }}</option>
            {% endfor %}
          </select>
        </div>
        <button type="button" class="button is-small is-info ml-2"
                onclick="addNewOption('recruitment')">+</button>
      </div>
    </div>

    <button class="button is-info mt-3" type="submit" name="action" value="save_section">
      Save Section
    </button>
  </div>

  <!-- PERFORMANCE & SALARY -->
  <div class="tab-content" id="performance" style="display: none;">
    <div class="field"><label class="label">Performance Score</label>
      <input class="input" type="number" name="performance_score" min="0" max="10"
             value="{{ form_data.get('performance_score','') }}">
    </div>
    <div class="field"><label class="label">Engagement Score</label>
      <input class="input" type="number" name="engagement_score" min="0" max="10"
             value="{{ form_data.get('engagement_score','') }}">
    </div>
    <div class="field"><label class="label">Employee Satisfaction</label>
      <input class="input" type="number" name="employee_satisfaction" min="0" max="10"
             value="{{ form_data.get('employee_satisfaction','') }}">
    </div>
    <div class="field"><label class="label">Salary</label>
      <input class="input" type="number" name="salary"
             value="{{ form_data.get('salary','') }}">
    </div>
    <div class="field"><label class="label">Special Project</label>
      <input class="input" type="number" name="special_project"
             value="{{ form_data.get('special_project','') }}">
    </div>

    <button class="button is-info mt-3" type="submit" name="action" value="save_section">Save Section</button>
  </div>

  <!-- OTHER DETAILS -->
  <div class="tab-content" id="other" style="display: none;">
    <div class="field">
      <label class="label">Country</label>
      <div class="control is-flex">
        <div class="select is-fullwidth">
          <select name="country" id="country" onchange="loadStates()">
            {% for c in dropdowns.get("country", ["India","USA"]) %}
              <option value="{{ c }}" {% if form_data.get("country") == c %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
          </select>
        </div>
        <button type="button" class="button is-small is-info ml-2"
                onclick="addNewOption('country')">+</button>
      </div>
    </div>

    <div class="field">
      <label class="label">State</label>
      <div class="select is-fullwidth">
        <select name="state" id="state">
          {% if states %}
            {% for s in states %}
              <option value="{{ s }}" {% if form_data.get("state") == s %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
          {% else %}
            <option>--Select Country First--</option>
          {% endif %}
        </select>
      </div>
    </div>

    <div class="field"><label class="label">ZIP</label><input class="input" type="text" name="zip"></div>
    <div class="field"><label class="label">DOB</label><input class="input" type="date" name="dob"></div>
    <div class="field"><label class="label">Date of Hire</label><input class="input" type="date" name="dateofhire"></div>
    <div class="field"><label class="label">Race</label><input class="input" type="text" name="race"></div>
    <div class="field"><label class="label">Last Performance Review Date</label><input class="input" type="date" name="last_review"></div>
    <div class="field"><label class="label">Days Late</label><input class="input" type="number" name="days_late"></div>
    <div class="field"><label class="label">Absences</label><input class="input" type="number" name="absences"></div>

    <button class="button is-info mt-3" type="submit" name="action" value="save_section">Save Section</button>
  </div>

  <!-- FINAL PROCEED -->
  <div class="field mt-5 has-text-centered">
    <button class="button is-primary is-large" type="submit" name="action" value="proceed">
      Proceed â†’ Save to Database
    </button>
  </div>
</form>

<!-- Tab Switching + Dynamic Logic -->
<script>
  // Tabs
  const tabs = document.querySelectorAll(".tabs li");
  const contents = document.querySelectorAll(".tab-content");
  tabs.forEach(tab => {
    tab.addEventListener("click", () => {
      tabs.forEach(t => t.classList.remove("is-active"));
      tab.classList.add("is-active");
      contents.forEach(c => c.style.display = "none");
      document.getElementById(tab.dataset.tab).style.display = "block";
    });
  });

  // Add option (POST to Flask + update dropdown)
  async function addNewOption(selectId) {
    let newValue = prompt("Enter new value:");
    if (!newValue) return;

    let response = await fetch("/add_option", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ field: selectId, value: newValue })
    });

    let result = await response.json();
    if (result.status === "success") {
      let select = document.getElementById(selectId);
      let opt = document.createElement("option");
      opt.text = newValue;
      opt.value = newValue;
      select.add(opt);
      select.value = newValue;
      alert(result.message);
    } else {
      alert("Error: " + result.message);
    }
  }

  // Termination reason toggle
  function toggleTerminationReason() {
    let term = document.getElementById("terminated").value;
    let reason = document.getElementById("termination_reason");
    reason.disabled = (term === "0");
    if (term === "0") reason.value = "N/A";
  }

  // Department ID (from data passed by backend, not hardcoded)
  function autoFillDepartmentId() {
    let deptSel = document.getElementById("department");
    let selected = deptSel.options[deptSel.selectedIndex];
    // backend can pass dept_id mapping in data-id attr
    document.getElementById("department_id").value = selected.getAttribute("data-id") || "";
  }

  // Manager ID (already has data-id)
  function autoFillManagerId() {
    let mgrSel = document.getElementById("manager_name");
    let selected = mgrSel.options[mgrSel.selectedIndex];
    document.getElementById("manager_id").value = selected.getAttribute("data-id") || "";
  }

  // States by country (loaded from backend ideally)
  function loadStates() {
    let ctry = document.getElementById("country").value;
    fetch(`/get_states/${ctry}`)
      .then(res => res.json())
      .then(data => {
        let stateSel = document.getElementById("state");
        stateSel.innerHTML = "";
        data.states.forEach(s => {
          let opt = document.createElement("option");
          opt.value = s;
          opt.text = s;
          stateSel.add(opt);
        });
      });
  }
</script>
{% endblock %}
